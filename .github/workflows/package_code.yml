#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to you under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: Generate release files

on:
  workflow_dispatch:
  push:
    branches:
      - master

permissions: read-all

jobs:

  package:
    name: Package code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871   # 4.2.1
        with:
          persist-credentials: false # do not persist auth token in the local git config

      - name: Determine version
        shell: bash
        run: |
          VERSION=$(sed -n -e "s/^set(log4cxx_VER \"\(.*\)\")/\1/p" < src/cmake/projectVersionDetails.cmake)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create release files
        shell: bash
        run: |
          ./package.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882   # 4.4.3
        if: always()
        with:
          name: apache-log4cxx
          path: |
            CMakeFiles/dist/*

  verify-reproducibility:
    name: Verify reproducibility
    needs: package
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ macos-latest, ubuntu-latest ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871   # 4.2.1
        with:
          persist-credentials: false # do not persist auth token in the local git config

      - name: Determine version
        shell: bash
        run: |
          VERSION=$(sed -n -e "s/^set(log4cxx_VER \"\(.*\)\")/\1/p" < src/cmake/projectVersionDetails.cmake)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16   # 4.1.8
        with:
          name: apache-log4cxx
          path: |
            CMakeFiles/reference

      - name: Check release files
        id: check
        shell: bash
        run: |
          ./package.sh
          current=CMakeFiles/dist/apache-log4cxx-$VERSION
          reference=CMakeFiles/reference/apache-log4cxx-$VERSION
          for format in tar.gz zip; do
            if ! cmp --silent "$reference.$format" "$current.$format"; then
              echo Files apache-log4cxx-$VERSION.$format differ\! >& 2
              exit 1
            fi
          done

      - name: Upload reproducibility results
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882   # 4.4.3
        if: ${{ failure() && steps.check.conclusion == 'failure' }}
        with:
          name: apache-log4cxx-reproducibility-${{ matrix.os }}
          path: |
            CMakeFiles/dist/*
